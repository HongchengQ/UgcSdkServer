<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API测试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; background: #007AFF; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056cc; }
        textarea { width: 100%; height: 150px; margin: 10px 0; }
        .result { background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0; }
        select { padding: 5px; margin: 0 10px; }
    </style>
</head>
<body>
    <h1>UGC转换API测试</h1>
    <p style="color: #666;">注意：请确保后端Spring Boot服务已在8080端口运行</p>
    
    <div class="test-section">
        <h2>健康检查</h2>
        <button onclick="testHealth()">测试健康检查</button>
        <div id="health-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>支持格式查询</h2>
        <button onclick="testFormats()">查询支持的格式</button>
        <div id="formats-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>正向转换测试</h2>
        <p>测试正向转换请求（Query Parameters + Request Body）</p>
        <div style="margin: 10px 0;">
            <label>输出格式: 
                <select id="outputFormat">
                    <option value="json">JSON</option>
                    <option value="yaml">YAML</option>
                    <option value="xml">XML</option>
                    <option value="csv">CSV</option>
                </select>
            </label>
        </div>
        <button onclick="testForwardConversion()">测试正向转换</button>
        <div id="forward-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>反向转换测试</h2>
        <p>测试反向转换请求（Query Parameters + Request Body）</p>
        <div style="margin: 10px 0;">
            <label>目标文件类型: 
                <select id="targetFileType">
                    <option value="gil">.gil</option>
                    <option value="gia">.gia</option>
                    <option value="gip">.gip</option>
                    <option value="gir">.gir</option>
                </select>
            </label>
        </div>
        <button onclick="testReverseConversion()">测试反向转换</button>
        <div id="reverse-result" class="result"></div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:8080'; // Spring Boot默认端口

        async function testHealth() {
            try {
                const response = await fetch(`${BASE_URL}/api/conversion/health`);
                const data = await response.json();
                document.getElementById('health-result').innerHTML = 
                    `<h3>状态: ${response.status}</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('health-result').innerHTML = 
                    `<h3 style="color: red;">错误: ${error.message}</h3>`;
            }
        }

        async function testFormats() {
            try {
                const response = await fetch(`${BASE_URL}/api/conversion/formats`);
                const data = await response.json();
                document.getElementById('formats-result').innerHTML = 
                    `<h3>状态: ${response.status}</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
            } catch (error) {
                document.getElementById('formats-result').innerHTML = 
                    `<h3 style="color: red;">错误: ${error.message}</h3>`;
            }
        }

        async function testForwardConversion() {
            const outputFormat = document.getElementById('outputFormat').value;
            
            // 创建测试二进制数据并转换为base64
            const testData = [71, 73, 65, 1, 0, 0, 0, 255, 255, 255, 255]; // 示例数据
            const uint8Array = new Uint8Array(testData);
            const base64Data = arrayBufferToBase64(uint8Array.buffer);
            
            // 数据体
            const requestData = {
                fileName: "test.gil",
                fileType: "gil",
                base64Data: base64Data
            };
            
            // 查询参数
            const queryParams = new URLSearchParams({
                outputFormat: outputFormat
            });

            try {
                const response = await fetch(`${BASE_URL}/api/conversion/forward?${queryParams.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.text();
                document.getElementById('forward-result').innerHTML = 
                    `<h3>状态: ${response.status}</h3>
                     <pre>${result}</pre>
                     <p><strong>请求URL:</strong> /api/conversion/forward?${queryParams.toString()}</p>
                     <p><strong>请求Body:</strong> ${JSON.stringify(requestData, null, 2)}</p>`;
            } catch (error) {
                document.getElementById('forward-result').innerHTML = 
                    `<h3 style="color: red;">错误: ${error.message}</h3>`;
            }
        }

        async function testReverseConversion() {
            const targetFileType = document.getElementById('targetFileType').value;
            
            // 创建测试数据并转换为base64
            const testJson = '{"test": "data", "value": 123}';
            const encoder = new TextEncoder();
            const uint8Array = encoder.encode(testJson);
            const base64Data = arrayBufferToBase64(uint8Array.buffer);
            
            // 数据体
            const requestData = {
                fileName: "test.json",
                fileType: "json",
                base64Data: base64Data
            };
            
            // 查询参数
            const queryParams = new URLSearchParams({
                targetFileType: targetFileType
            });

            try {
                const response = await fetch(`${BASE_URL}/api/conversion/reverse?${queryParams.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.text();
                document.getElementById('reverse-result').innerHTML = 
                    `<h3>状态: ${response.status}</h3>
                     <pre>${result.substring(0, 100)}...</pre>
                     <p><strong>请求URL:</strong> /api/conversion/reverse?${queryParams.toString()}</p>
                     <p><strong>请求Body:</strong> ${JSON.stringify(requestData, null, 2)}</p>`;
            } catch (error) {
                document.getElementById('reverse-result').innerHTML = 
                    `<h3 style="color: red;">错误: ${error.message}</h3>`;
            }
        }
    </script>
</body>
</html>